<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品详情 - Super NiuBi Market</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/api.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{background:#0a0a0a;color:#e0e0e0;font-family:"Microsoft YaHei","PingFang SC",Arial,sans-serif;line-height:1.6;}
        a{text-decoration:none;}

        .main-header{
            background:rgba(15,15,15,0.95);backdrop-filter:blur(10px);
            padding:15px 5%;display:flex;align-items:center;justify-content:space-between;
            position:sticky;top:0;z-index:100;border-bottom:1px solid #333;
        }
        .logo a{color:#00FFFF;font-size:1.8em;font-weight:bold;}
        .main-nav ul{display:flex;list-style:none;gap:30px;}
        .main-nav a{color:#ccc;}
        .main-nav a:hover,.main-nav a.active{color:#00FFFF;}
        .user-actions a{margin-left:15px;color:#aaa;}
        .user-actions span{color:#00FFFF;}
        #logoutBtn{color:#FF4700 !important;cursor:pointer;}

        .detail-container{
            max-width:1300px;margin:40px auto;padding:0 20px;
            display:grid;grid-template-columns:580px 1fr;gap:50px;
        }
        @media (max-width:968px){.detail-container{grid-template-columns:1fr;gap:30px;}}

        .gallery{position:relative;}
        .main-img{width:100%;height:500px;object-fit:cover;border-radius:16px;border:1px solid #333;}
        .thumb-list{display:flex;gap:12px;margin-top:15px;overflow-x:auto;padding:10px 0;}
        .thumb{width:90px;height:90px;object-fit:cover;border-radius:10px;
              border:2px solid #333;cursor:pointer;opacity:0.6;transition:all .3s;}
        .thumb.active,.thumb:hover{opacity:1;border-color:#00FFFF;box-shadow:0 0 15px rgba(0,255,255,.4);}
        .arrow{
            position:absolute;top:50%;transform:translateY(-50%);
            background:rgba(0,0,0,.6);color:#00FFFF;width:50px;height:50px;
            border-radius:50%;display:flex;align-items:center;justify-content:center;
            font-size:28px;cursor:pointer;user-select:none;backdrop-filter:blur(5px);
        }
        .arrow-left{left:15px;}.arrow-right{right:15px;}

        .info h1{font-size:2.5em;color:#00FFFF;margin-bottom:15px;}
        .desc{font-size:1.15em;color:#bbb;line-height:1.8;margin-bottom:30px;}
        .price-box{background:#181818;padding:25px;border-radius:16px;border:1px solid #333;margin:30px 0;}
        .current-price{font-size:3.2em;font-weight:bold;color:#FF4700;text-shadow:0 0 15px rgba(255,71,0,.6);}
        .meta-info{color:#888;margin:20px 0;font-size:1.1em;}
        .meta-info span{margin-right:30px;}

        .actions{display:flex;gap:20px;margin-top:40px;}
        .btn{
            padding:18px 45px;border-radius:14px;font-size:1.3em;
            font-weight:bold;cursor:pointer;transition:all .3s;border:none;
        }
        .btn-add{background:#00FFFF;color:#000;}
        .btn-add:hover{background:#00ffff;transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,255,255,.4);}
        .btn-buy{background:linear-gradient(45deg,#FF4700,#ff6b3d);color:white;}
        .btn-buy:hover{transform:translateY(-4px);box-shadow:0 12px 35px rgba(255,71,0,.5);}

        .toast{
            position:fixed;bottom:100px;left:50%;transform:translateX(-50%);
            background:rgba(0,255,255,.1);color:#00FFFF;padding:18px 50px;
            border-radius:50px;border:1px solid #00FFFF;backdrop-filter:blur(10px);
            box-shadow:0 10px 30px rgba(0,255,255,.3);z-index:9999;
            opacity:0;transition:all .5s;pointer-events:none;
        }
        .toast.show{opacity:1;transform:translateX(-50%) translateY(-20px);}
    </style>
</head>
<body>

<header class="main-header">
    <div class="logo"><a href="index.html">Super NiuBi Market</a></div>
    <nav class="main-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="products.html">Products</a></li>
            <li><a href="about.html">About Us</a></li>
        </ul>
    </nav>
    <div class="user-actions">
        <a href="register.html">Register</a> / <a href="login.html">Login</a>
        <a href="cart.html">Shopping Cart(<span id="cartCount">0</span>)</a>
    </div>
</header>

<main>
    <div class="detail-container">
        <!-- 图片区 -->
        <div class="gallery">
            <img id="mainImg" class="main-img" src="" alt="商品主图">
            <div class="arrow arrow-left">←</div>
            <div class="arrow arrow-right">→</div>
            <div class="thumb-list" id="thumbList"></div>
        </div>

        <!-- 信息区 -->
        <div class="info">
            <h1 id="title">Loading...</h1>
            <p class="desc" id="desc"></p>

            <div class="price-box">
                <div class="current-price" id="price">$ 0.00</div>
                <div class="meta-info">
                    <span>Sales: <strong id="sales">0</strong> pc</span>
                    <span>Stock: <strong id="stock">0</strong> pc</span>
                    <span>ProductID: <strong id="pid">000000</strong></span>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-add" id="addToCart">Add to Cart</button>
                <button class="btn btn-buy" id="buyNow">Buy</button>
            </div>
        </div>
    </div>
</main>

<!-- 提示框 -->
<div class="toast" id="toast"> Add to Cart Successfully</div>

<!-- ==================== 完整脚本：登录态 + 真实商品详情 + 真实购物车 ==================== -->
<script>
// ==================== 通用登录态处理 ====================
let currentUser = null;
try {
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');
    if (token && userStr) currentUser = JSON.parse(userStr);
} catch (e) {}

function updateNav() {
    const $actions = $('.user-actions');
    if (currentUser) {
        $actions.html(`
            <span>欢迎，${currentUser.name}</span>
            <a href="cart.html">Cart (<span id="cartCount">0</span>)</a>
            <a href="#" id="logoutBtn">Exit</a>
        `);
        $('#logoutBtn').click(e => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            location.reload();
        });
    }
}

async function updateCartCount() {
    if (!currentUser) {
        $('#cartCount').text('0');
        return;
    }
    try {
        const cart = await API.get('/user/cart');
        const count = cart.reduce((s,i)=>s+i.quantity,0);
        $('#cartCount').text(count);
    } catch (err) {
        $('#cartCount').text('0');
    }
}

// ==================== 真实加载商品详情 ====================
let currentProduct = null;
let currentImgIndex = 0;

async function loadProduct() {
    const id = new URLSearchParams(window.location.search).get('id');
    if (!id) {
        alert('No Exist');
        return;
    }

    try {
        currentProduct = await API.get(`/products/${id}`);
        
        // 填充信息
        document.title = currentProduct.name + " - Super NiuBi Market";
        $('#title').text(currentProduct.name);
        $('#desc').text(currentProduct.description || 'No description');
        $('#price').text('¥ ' + parseFloat(currentProduct.price).toFixed(2));
        $('#sales').text(currentProduct.salesCount || 0);
        $('#stock').text(currentProduct.stock || 0);
        $('#pid').text(currentProduct.id);

        // 渲染图片
        const images = currentProduct.images || [{url: 'images/微信图片_20251206235409.png'}];
        $('#mainImg').attr('src', images[0].url);
        
        const $thumbList = $('#thumbList').empty();
        images.forEach((img, i) => {
            const thumb = $(`<img src="${img.url}" class="thumb" alt="缩略图">`);
            if (i === 0) thumb.addClass('active');
            thumb.click(() => switchImage(i));
            $thumbList.append(thumb);
        });

    } catch (err) {
        alert('Failed to load product details');
        console.error(err);
        document.body.innerHTML = '<h1 style="text-align:center;margin-top:100px;color:#f66;">商品不存在</h1>';
    }
}

function switchImage(index) {
    if (!currentProduct) return;
    currentImgIndex = index;
    const images = currentProduct.images || [];
    $('#mainImg').attr('src', images[index]?.url || '');
    $('.thumb').removeClass('active').eq(index).addClass('active');
}

// 左右箭头
$('.arrow-left').click(() => {
    currentImgIndex = (currentImgIndex - 1 + (currentProduct?.images?.length || 1)) % (currentProduct?.images?.length || 1);
    switchImage(currentImgIndex);
});
$('.arrow-right').click(() => {
    currentImgIndex = (currentImgIndex + 1) % (currentProduct?.images?.length || 1);
    switchImage(currentImgIndex);
});

// ==================== 真实加入购物车 ====================
async function addToCart(qty = 1) {
    if (!currentUser) {
        if (confirm('Login required.')) {
            location.href = 'login.html';
        }
        return;
    }

    try {
        await API.post('/user/cart', {
            productId: currentProduct.id,
            quantity: qty
        });
        $('#toast').addClass('show');
        setTimeout(() => $('#toast').removeClass('show'), 2000);
        updateCartCount();
    } catch (err) {
        alert('Failed：' + (err.message || 'Unknown error'));
    }
}

$('#addToCart').click(() => addToCart(1));
$('#buyNow').click(() => {
    addToCart(1).then(() => {
        location.href = 'cart.html';
    });
});

// ==================== 初始化 ====================
$(document).ready(function() {
    updateNav();
    updateCartCount();
    loadProduct();
});
</script>

</body>
</html>