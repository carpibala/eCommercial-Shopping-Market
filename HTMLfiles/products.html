<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>所有商品 - Super NiuBi Market</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/api.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{background:#0a0a0a;color:#e0e0e0;font-family:"Microsoft YaHei","PingFang SC",Arial,sans-serif;line-height:1.6;}
        a{text-decoration:none;color:inherit;}

        .main-header{
            background:rgba(15,15,15,0.95);backdrop-filter:blur(10px);
            padding:15px 5%;display:flex;align-items:center;justify-content:space-between;
            position:sticky;top:0;z-index:100;border-bottom:1px solid #333;
        }
        .logo a{color:#00FFFF;font-size:1.8em;font-weight:bold;}
        .main-nav ul{display:flex;list-style:none;gap:30px;}
        .main-nav a{color:#ccc;transition:0.3s;}
        .main-nav a:hover,.main-nav a.active{color:#00FFFF;}
        .user-actions a{margin-left:15px;color:#aaa;}
        .user-actions span{color:#00FFFF;}
        #logoutBtn{color:#FF4700 !important;cursor:pointer;}

        .page-title{
            text-align:center;font-size:2.8em;margin:50px 0 20px;color:#f0f0f0;position:relative;
        }
        .page-title::after{
            content:'';position:absolute;left:50%;bottom:-15px;transform:translateX(-50%);
            width:120px;height:5px;background:#00FFFF;border-radius:3px;box-shadow:0 0 20px #00FFFF;
        }

        .top-filter-bar{background:#181818;padding:20px 0;margin-bottom:30px;border-bottom:1px solid #333;}
        .filter-main-row{
            max-width:1400px;margin:0 auto;padding:0 20px;
            display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px;
        }
        .filter-left,.filter-right{display:flex;align-items:center;gap:15px;flex-wrap:wrap;}
        .search-box{
            width:300px;padding:12px 18px;background:#111;border:2px solid #444;
            border-radius:10px;color:white;font-size:1em;
        }
        .search-box:focus{outline:none;border-color:#00FFFF;box-shadow:0 0 0 4px rgba(0,255,255,0.2);}
        .btn-search,.btn-apply{
            background:#00FFFF;color:#000;border:none;padding:12px 25px;
            border-radius:10px;font-weight:bold;cursor:pointer;transition:0.3s;
        }
        .btn-search:hover,.btn-apply:hover{background:#00ffffcc;}

        .category-buttons{display:flex;gap:10px;flex-wrap:wrap;}
        .cat-btn{
            padding:8px 18px;background:#222;border:1px solid #444;
            border-radius:8px;color:#ccc;transition:0.3s;
        }
        .cat-btn:hover,.cat-btn.active{
            background:#00FFFF;color:#000;border-color:#00FFFF;
        }

        .price-input{
            width:110px;padding:10px 12px;background:#111;border:1px solid #444;
            border-radius:8px;color:#fff;
        }
        .filter-label{color:#aaa;}

        .sort-bar-full{
            max-width:1400px;margin:0 auto 30px;padding:15px 20px;
            background:#181818;border-radius:12px;display:flex;justify-content:space-between;
            align-items:center;border:1px solid #333;
        }
        #sortCriteria{
            padding:8px 12px;background:#111;border:1px solid #444;
            border-radius:8px;color:white;
        }

        .container{max-width:1400px;margin:0 auto;padding:0 20px;}
        .product-grid-full{
            display:grid;grid-template-columns:repeat(4,1fr);gap:28px;
        }
        @media (max-width:1200px){.product-grid-full{grid-template-columns:repeat(3,1fr);}}
        @media (max-width:900px){.product-grid-full{grid-template-columns:repeat(2,1fr);}}
        @media (max-width:600px){.product-grid-full{grid-template-columns:1fr;}}

        .product-card{
            background:#1a1a1a;border-radius:16px;overflow:hidden;
            border:1px solid #2a2a2a;box-shadow:0 8px 25px rgba(0,0,0,0.6);
            transition:all 0.4s;display:block;
        }
        .product-card:hover{
            transform:translateY(-12px);box-shadow:0 20px 40px rgba(0,255,255,0.25);
            border-color:#00FFFF;
        }
        .product-card img{width:100%;height:220px;object-fit:cover;}
        .card-content{padding:18px;}
        .card-title{font-size:1.35em;font-weight:bold;color:#00FFFF;margin-bottom:8px;}
        .card-description{
            color:#aaa;font-size:0.95em;line-height:1.5;height:48px;overflow:hidden;
            display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
        }
        .card-price{font-size:1.9em;font-weight:bold;color:#FF4700;margin:12px 0;
                    text-shadow:0 0 12px rgba(255,71,0,0.6);}
        .card-meta{color:#777;font-size:0.9em;}
    </style>
</head>
<body>

<header class="main-header">
    <div class="logo"><a href="index.html">Super NiuBi Market</a></div>
    <nav class="main-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="products.html" style="color:#00FFFF;">Products</a></li>
            <li><a href="about.html">About Us</a></li>
        </ul>
    </nav>
    <div class="user-actions">
        <a href="register.html">Register</a> / <a href="login.html">Login</a>
        <a href="cart.html">Shopping Cart (<span id="cartCount">0</span>)</a>
    </div>
</header>

<main>
    <h1 class="page-title">Explore the latest tech products</h1>

    <!-- 顶部筛选栏 -->
    <div class="top-filter-bar">
        <div class="filter-main-row">
            <div class="filter-left">
                <input type="text" id="searchInput" class="search-box" placeholder="Keyboard, mouse, headphones...">
                <button class="btn-search">Search</button>

                <span class="filter-label">Category:</span>
                <div class="category-buttons">
                    <button class="cat-btn active" data-category="all">All</button>
                    <button class="cat-btn" data-category="keyboards">Mechanical keyboard</button>
                    <button class="cat-btn" data-category="mouses">Gaming mouse</button>
                    <button class="cat-btn" data-category="headsets">Gaming headset</button>
                    <button class="cat-btn" data-category="others">Other accessories</button>
                </div>
            </div>

            <div class="filter-right">
                <span class="filter-label">Price：</span>
                <input type="number" id="minPrice" class="price-input" placeholder="Min">
                <span style="color:#999;">–</span>
                <input type="number" id="maxPrice" class="price-input" placeholder="Max">
                <button class="btn-apply">use</button>
            </div>
        </div>
    </div>

    <!-- 排序 + 商品列表 -->
    <div class="container">
        <div class="sort-bar-full">
            <span>total Found <strong id="productCount">0</strong> product(s)</span>
            <select id="sortCriteria">
                <option value="default">Default order</option>
                <option value="price_asc">Price: Low to High</option>
                <option value="price_desc">Price: High to Low</option>
                <option value="sales_desc">Sales from high to low</option>
            </select>
        </div>

        <div id="productGrid" class="product-grid-full">
            <p style="grid-column:1/-1;text-align:center;color:#888;font-size:1.5em;">Loading...</p>
        </div>
    </div>
</main>

<!-- ==================== 完整脚本：登录态 + 真实商品列表 + 真实筛选 ==================== -->
<script>
// ==================== 通用登录态处理 ====================
let currentUser = null;
try {
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');
    if (token && userStr) currentUser = JSON.parse(userStr);
} catch (e) {}

function updateNav() {
    const $actions = $('.user-actions');
    if (currentUser) {
        $actions.html(`
            <span>Welcome，${currentUser.name}</span>
            <a href="cart.html">Shopping Cart (<span id="cartCount">0</span>)</a>
            <a href="#" id="logoutBtn">Exit</a>
        `);
        $('#logoutBtn').click(e => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            location.reload();
        });
    }
}

async function updateCartCount() {
    if (!currentUser) {
        $('#cartCount').text('0');
        return;
    }
    try {
        const cart = await API.get('/user/cart');
        const count = cart.reduce((s,i)=>s+i.quantity,0);
        $('#cartCount').text(count);
    } catch (err) {
        $('#cartCount').text('0');
    }
}

// ==================== 真实商品数据（从后端获取） ====================
let allProducts = [];

async function loadProducts() {
    try {
        allProducts = await API.get('/products');
        renderProducts(allProducts);
    } catch (err) {
        $('#productGrid').html('<p style="grid-column:1/-1;color:#f66;text-align:center;">加载失败，请刷新重试</p>');
    }
}

// ==================== 渲染商品卡片 ====================
function renderProducts(list) {
    const $grid = $('#productGrid');
    $grid.empty();

    if (list.length === 0) {
        $grid.append('<p style="grid-column:1/-1;text-align:center;color:#888;font-size:1.5em;">暂无符合条件的商品</p>');
        $('#productCount').text('0');
        return;
    }

    list.forEach(p => {
        const card = $(`
            <a href="product_detail.html?id=${p.id}" class="product-card">
                <img src="${p.images?.[0]?.url || 'images/微信图片_20251206235409.png'}" alt="${p.name}">
                <div class="card-content">
                    <h3 class="card-title">${p.name}</h3>
                    <p class="card-description">${p.description || '暂无描述'}</p>
                    <div class="card-price">¥ ${parseFloat(p.price).toFixed(2)}</div>
                    <div class="card-meta">
                        sales : ${p.salesCount || 0} 　stock: ${p.stock || 0}
                    </div>
                </div>
            </a>
        `);
        $grid.append(card);
    });

    $('#productCount').text(list.length);
}

// ==================== 筛选 + 排序 ====================
function filterAndFilterSort() {
    let filtered = [...allProducts];

    // 关键词搜索
    const keyword = $('#searchInput').val().trim().toLowerCase();
    if (keyword) {
        filtered = filtered.filter(p =>
            p.name.toLowerCase().includes(keyword) ||
            (p.description && p.description.toLowerCase().includes(keyword))
        );
    }

    // 分类
    const activeCat = document.querySelector('.cat-btn.active');
    const category = activeCat ? activeCat.dataset.category : 'all';
    if (category !== 'all') {
        filtered = filtered.filter(p => p.category === category);
    }

    // 价格区间
    const min = $('#minPrice').val();
    const max = $('#maxPrice').val();
    if (min) filtered = filtered.filter(p => p.price >= Number(min));
    if (max) filtered = filtered.filter(p => p.price <= Number(max));

    // 排序
    const sort = $('#sortCriteria').val();
    if (sort === 'price_asc') filtered.sort((a,b) => a.price - b.price);
    if (sort === 'price_desc') filtered.sort((a,b) => b.price - a.price);
    if (sort === 'sales_desc') filtered.sort((a,b) => (b.salesCount||0) - (a.salesCount||0));

    renderProducts(filtered);
}

// ==================== 事件绑定 ====================
$(document).ready(function() {
    updateNav();
    updateCartCount();
    loadProducts();

    // 搜索
    $('.btn-search').click(filterAndFilterSort);
    $('#searchInput').on('keypress', e => { if(e.which===13) filterAndFilterSort(); });

    // 分类按钮
    $('.cat-btn').click(function(e) {
        e.preventDefault();
        $('.cat-btn').removeClass('active');
        $(this).addClass('active');
        filterAndFilterSort();
    });

    // 价格应用
    $('.btn-apply').click(filterAndFilterSort);
    $('#minPrice, #maxPrice').on('keypress', e => { if(e.which===13) filterAndFilterSort(); });

    // 排序
    $('#sortCriteria').change(filterAndFilterSort);
});
</script>

</body>
</html>